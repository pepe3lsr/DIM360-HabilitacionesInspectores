<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DIM360 - Sistema de Inspecciones de Habilitaciones</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: Arial, Helvetica, sans-serif;
      background: #f6f6f6;
      min-height: 100vh;
      padding: 0;
      font-size: 14px;
    }

    .container { max-width: 1400px; margin: 0 auto; padding: 0 20px 20px; }

    .header {
      background: white;
      padding: 24px 30px;
      border-radius: 0 0 12px 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 18px;
      color: #1a1a1a;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .tab {
      padding: 8px 16px;
      background: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .tab:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .tab.active { background: #0066ff; color: white; }

    .panel { display: none; animation: fadeIn 0.3s; }
    .panel.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .card h2 {
      font-size: 16px;
      color: #1a1a1a;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-group { margin-bottom: 16px; }

    .form-group label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 6px;
      font-size: 13px;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #0066ff;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .form-row-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 16px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .btn-primary { background: #0066ff; color: white; }
    .btn-success { background: #0066ff; color: white; }
    .btn-danger { background: #c62828; color: white; }
    .btn-warning { background: #3385ff; color: white; }
    .btn-sm { padding: 6px 12px; font-size: 12px; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      border-left: 5px solid;
    }

    .stat-card.pending { border-left-color: #ffc107; }
    .stat-card.completed { border-left-color: #0066ff; }
    .stat-card.total { border-left-color: #0066ff; }
    .stat-card.import { border-left-color: #3385ff; }

    .stat-number { font-size: 26px; font-weight: bold; color: #1a1a1a; margin-bottom: 4px; }
    .stat-label { font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }

    .table-container {
      overflow-x: auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    table { width: 100%; border-collapse: collapse; }
    thead { background: #f8f9fa; border-bottom: 2px solid #e0e0e0; }

    th {
      padding: 12px 14px;
      text-align: left;
      font-weight: 600;
      color: #333;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    td {
      padding: 12px 14px;
      border-bottom: 1px solid #f0f0f0;
      color: #555;
      font-size: 13px;
    }

    tr:hover { background: #f8f9fa; }

    .status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      display: inline-block;
    }

    .status-pending { background: #fff3cd; color: #856404; }
    .status-in_progress { background: #cce5ff; color: #004085; }
    .status-completed { background: #d4edda; color: #155724; }
    .status-synced { background: #d4edda; color: #155724; }

    .action-btn {
      padding: 4px 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s;
      margin-right: 4px;
    }

    .btn-view { background: #0066ff; color: white; }
    .btn-delete { background: #c62828; color: white; }
    .btn-assign { background: #3385ff; color: white; }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active { display: flex; }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 16px;
      max-width: 800px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e0e0e0;
    }

    .modal-header h2 { font-size: 20px; color: #1a1a1a; }

    .close-btn {
      background: none; border: none;
      font-size: 28px; cursor: pointer; color: #999;
    }

    .close-btn:hover { color: #c62828; }

    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 20px;
    }

    .detail-item {
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #0066ff;
    }

    .detail-label {
      font-size: 11px; color: #666; text-transform: uppercase;
      letter-spacing: 0.5px; margin-bottom: 4px; font-weight: 600;
    }

    .detail-value { font-size: 14px; color: #1a1a1a; word-break: break-word; }

    .image-preview {
      width: 100%; max-width: 400px;
      border-radius: 8px; margin-top: 8px;
    }

    /* Alerts */
    .alert {
      padding: 14px 18px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: none;
      animation: slideIn 0.3s;
    }

    .alert.active { display: block; }

    @keyframes slideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .alert-success { background: #d4edda; color: #155724; border-left: 4px solid #0066ff; }
    .alert-error { background: #f8d7da; color: #721c24; border-left: 4px solid #c62828; }

    /* Upload area */
    .upload-area {
      border: 3px dashed #0066ff;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      background: #e6f0ff;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 20px;
    }

    .upload-area:hover { background: #e6f0ff; border-color: #0052cc; }
    .upload-area.dragover { background: #b6cfe5; border-color: #0052cc; }
    .upload-icon { font-size: 48px; margin-bottom: 12px; }
    .upload-text { font-size: 16px; color: #333; font-weight: 600; }
    .upload-hint { font-size: 13px; color: #666; margin-top: 8px; }

    .import-result {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-top: 16px;
    }

    .import-stat {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 6px;
      margin: 4px;
      font-weight: 600;
      font-size: 13px;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }

    .empty-state-icon { font-size: 48px; margin-bottom: 12px; }

    .zone-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      background: #e6f0ff;
      color: #0066ff;
    }

    .inspector-card {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .inspector-info h3 { font-size: 16px; color: #1a1a1a; margin-bottom: 4px; }
    .inspector-info p { font-size: 13px; color: #666; }

    .inspector-stats {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .inspector-stat {
      text-align: center;
    }

    .inspector-stat .num { font-size: 20px; font-weight: bold; }
    .inspector-stat .label { font-size: 10px; color: #666; text-transform: uppercase; }

    .checkbox-cell { width: 30px; text-align: center; }
    .checkbox-cell input { cursor: pointer; width: 16px; height: 16px; }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="loginScreen" style="display:flex;flex-direction:column;align-items:center;min-height:100vh;background:#f6f6f6;">
    <div style="width:100%;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.1);padding:20px;text-align:center;">
      <img src="/img/logo-dim360.png" alt="DIM360" style="max-height:80px;">
    </div>
    <div style="background:#fff;border-radius:16px;padding:40px;width:360px;box-shadow:0 20px 60px rgba(0,0,0,0.1);margin-top:60px;">
      <h2 style="text-align:center;margin-bottom:8px;color:#0066ff;">DIM360</h2>
      <p style="text-align:center;color:#666;margin-bottom:24px;">Sistema de Inspecciones de Habilitaciones</p>
      <div id="loginError" style="display:none;background:#fee;color:#c00;padding:10px;border-radius:8px;margin-bottom:16px;font-size:13px;"></div>
      <input id="loginEmail" type="email" placeholder="Email" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:12px;box-sizing:border-box;font-size:14px;">
      <input id="loginPassword" type="password" placeholder="Contrase√±a" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:20px;box-sizing:border-box;font-size:14px;"
        onkeydown="if(event.key==='Enter')doLogin()">
      <button onclick="doLogin()" style="width:100%;padding:14px;background:#0066ff;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:16px;font-weight:600;">Ingresar</button>
    </div>
  </div>

  <!-- PANEL PRINCIPAL (oculto hasta login) -->
  <div id="mainPanel" class="container" style="display:none;">
    <!-- Header DIM360 -->
    <div style="background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin:0 -20px;padding:15px;text-align:center;border-bottom:3px solid #0066ff;">
      <img src="/img/logo-dim360.png" alt="DIM360" style="max-height:60px;">
      <div style="font-size:11px;color:#666;margin-top:5px;">Municipalidad de San Miguel de Tucum√°n</div>
    </div>
    <div class="header" style="margin-top:20px;">
      <h1 style="color:#0066ff;">Sistema de Inspecciones de Habilitaciones</h1>
      <div>
        <span id="adminName" style="color:#666;font-size:13px;margin-right:12px;"></span>
        <button onclick="doLogout()" style="padding:6px 14px;background:#0066ff;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:12px;">Cerrar sesion</button>
      </div>
    </div>

    <div id="alertSuccess" class="alert alert-success"></div>
    <div id="alertError" class="alert alert-error"></div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('dashboard', this)">üìä Dashboard</button>
      <button class="tab" onclick="switchTab('import', this)">üìÑ Importar CSV</button>
      <button class="tab" onclick="switchTab('list', this)">üìã Inspecciones</button>
      <button class="tab" onclick="switchTab('assign', this)">üó∫Ô∏è Asignar</button>
      <button class="tab" onclick="switchTab('recorridos', this)">üìç Recorridos</button>
      <button class="tab" onclick="switchTab('inspectors', this)">üë• Inspectores</button>
      <button class="tab" onclick="switchTab('create', this)">‚ûï Carga Manual</button>
    </div>

    <!-- Panel: Dashboard -->
    <div id="dashboard-panel" class="panel active">
      <div class="stats-grid">
        <div class="stat-card total" style="cursor:pointer" onclick="goToListWithFilter('')" title="Ver todas">
          <div class="stat-number" id="stat-total">0</div>
          <div class="stat-label">Total Inspecciones</div>
        </div>
        <div class="stat-card pending" style="cursor:pointer" onclick="goToListWithFilter('pending')" title="Ver pendientes">
          <div class="stat-number" id="stat-pending">0</div>
          <div class="stat-label">Pendientes</div>
        </div>
        <div class="stat-card completed" style="cursor:pointer" onclick="goToListWithFilter('completed')" title="Ver completadas">
          <div class="stat-number" id="stat-completed">0</div>
          <div class="stat-label">Completadas</div>
        </div>
        <div class="stat-card import" style="cursor:pointer" onclick="switchTab('import-panel')" title="Ver importaciones">
          <div class="stat-number" id="stat-imports">0</div>
          <div class="stat-label">Importaciones</div>
        </div>
      </div>

      <div class="card">
        <h2>üìà Inspecciones Recientes</h2>
        <div id="recent-inspections">
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <p>Cargando...</p>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>üì¶ Importaciones Realizadas</h2>
        <div id="import-history"></div>
        <div id="pag-dashImports" style="display:flex; justify-content:center; align-items:center; gap:8px; padding:12px; flex-wrap:wrap;"></div>
      </div>
    </div>

    <!-- Panel: Importar CSV de Habilitaciones -->
    <div id="import-panel" class="panel">
      <div class="card">
        <h2>üìÑ Importar CSV de Habilitaciones</h2>
        <p style="color: #666; margin-bottom: 20px;">
          Sube un archivo CSV con las habilitaciones a inspeccionar.
          Columnas requeridas: numero_habilitacion, nombre_comercio, titular, cuit, direccion, rubro, tipo_habilitacion, zona
        </p>

        <div class="upload-area" id="uploadArea" onclick="document.getElementById('csvFile').click()">
          <div class="upload-icon">üìÑ</div>
          <div class="upload-text">Arrastr√° o hac√© clic para subir el CSV</div>
          <div class="upload-hint">Formato: CSV con habilitaciones para inspecci√≥n</div>
        </div>

        <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="uploadCSV()">

        <div id="uploadProgress" style="display: none;">
          <div style="text-align: center; padding: 20px;">
            <div style="border: 4px solid #f3f3f3; border-top: 4px solid #0066ff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
            <p style="margin-top: 12px; color: #666;">Procesando CSV...</p>
          </div>
        </div>

        <div id="importResult" style="display: none;"></div>
      </div>

      <div class="card">
        <h2>üì¶ Historial de Importaciones</h2>
        <div id="import-batches-list"></div>
        <div id="pag-importBatches" style="display:flex; justify-content:center; align-items:center; gap:8px; padding:12px; flex-wrap:wrap;"></div>
      </div>
    </div>

    <!-- Panel: Lista de Inspecciones -->
    <div id="list-panel" class="panel">
      <div class="card" style="margin-bottom: 16px;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
          <h2 style="margin-bottom: 0;">üìã Todas las Inspecciones</h2>
          <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
            <input id="filterSearch" type="text" placeholder="Buscar por comercio, direcci√≥n..." oninput="loadInspections()" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; font-size: 13px; min-width: 200px;">
            <select id="filterZone" onchange="loadInspections()" style="padding: 8px; border-radius: 6px; border: 1px solid #ddd; font-size: 13px;">
              <option value="">Todas las zonas</option>
            </select>
            <select id="filterStatus" onchange="loadInspections()" style="padding: 8px; border-radius: 6px; border: 1px solid #ddd; font-size: 13px;">
              <option value="">Todos los estados</option>
              <option value="pending">Pendientes</option>
              <option value="in_progress">En Progreso</option>
              <option value="completed">Completadas</option>
            </select>
            <select id="filterSort" onchange="loadInspections()" style="padding: 8px; border-radius: 6px; border: 1px solid #ddd; font-size: 13px;">
              <option value="newest">M√°s recientes</option>
              <option value="oldest">M√°s antiguas</option>
              <option value="name_asc">Nombre A-Z</option>
              <option value="name_desc">Nombre Z-A</option>
            </select>
            <button class="btn btn-success btn-sm" onclick="loadInspections()">üîÑ Refrescar</button>
          </div>
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Nro Hab.</th>
              <th>Comercio</th>
              <th>Titular</th>
              <th>Direcci√≥n</th>
              <th>Zona</th>
              <th>Estado</th>
              <th>Fecha Alta</th>
              <th>Inspector</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="inspections-table">
          </tbody>
        </table>
        <div id="pagination-controls" style="display:flex; justify-content:center; align-items:center; gap:8px; padding:16px; flex-wrap:wrap;"></div>
      </div>
    </div>

    <!-- Panel: Asignar Recorridos -->
    <div id="assign-panel" class="panel">
      <div class="card">
        <h2>üó∫Ô∏è Asignar Recorridos por Zona</h2>
        <p style="color: #666; margin-bottom: 20px;">
          Seleccion√° una zona y asignala a un inspector. Las inspecciones pendientes de esa zona se asignar√°n autom√°ticamente.
        </p>

        <div id="zone-assignment-list"></div>
      </div>

      <div class="card">
        <h2>üìå Asignaci√≥n Individual</h2>
        <p style="color: #666; margin-bottom: 20px;">
          Seleccion√° inspecciones espec√≠ficas para asignar a un inspector.
        </p>

        <div class="form-row" style="margin-bottom: 16px;">
          <div class="form-group">
            <label>Inspector</label>
            <select id="assignInspector">
              <option value="">Seleccionar inspector...</option>
            </select>
          </div>
          <div class="form-group" style="display: flex; align-items: flex-end;">
            <button class="btn btn-warning" onclick="assignSelected()">üìå Asignar Seleccionadas</button>
          </div>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th class="checkbox-cell"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                <th>Nro Hab.</th>
                <th>Comercio</th>
                <th>Direcci√≥n</th>
                <th>Zona</th>
              </tr>
            </thead>
            <tbody id="pending-inspections-table"></tbody>
          </table>
          <div id="pag-assignPending" style="display:flex; justify-content:center; align-items:center; gap:8px; padding:12px; flex-wrap:wrap;"></div>
        </div>
      </div>
    </div>

    <!-- Panel: Recorridos -->
    <div id="recorridos-panel" class="panel">
      <div class="card">
        <h2>üìç Recorridos Asignados</h2>
        <div id="recorridos-list"></div>
        <div id="pag-recorridos" style="display:flex; justify-content:center; align-items:center; gap:8px; padding:12px; flex-wrap:wrap;"></div>
      </div>
      <div id="recorrido-detail" class="card" style="display:none;">
        <h3 id="recorrido-detail-title"></h3>
        <div style="margin-bottom:12px; display:flex; gap:8px; justify-content:flex-end;">
          <button class="btn btn-danger btn-sm" onclick="unassignAll()">Desasignar todo</button>
          <button class="btn btn-danger btn-sm" onclick="unassignSelected()">Desasignar seleccionados</button>
        </div>
        <table id="recorrido-detail-table">
          <thead><tr><th><input type="checkbox" onchange="toggleAllRecorrido(this)"></th><th>Orden</th><th>Cliente</th><th>Direcci√≥n</th><th>Zona</th><th>Estado</th></tr></thead>
          <tbody></tbody>
        </table>
        <div id="pag-recorridoDetail" style="display:flex; justify-content:center; align-items:center; gap:8px; padding:12px; flex-wrap:wrap;"></div>
      </div>
    </div>

    <!-- Panel: Usuarios -->
    <div id="inspectors-panel" class="panel">
      <div class="card">
        <h2>üë• Gesti√≥n de Inspectores</h2>
        <div id="inspectors-list"></div>
        <div id="pag-inspectorsList" style="display:flex; justify-content:center; align-items:center; gap:8px; padding:12px; flex-wrap:wrap;"></div>

        <hr style="margin: 24px 0; border: none; border-top: 1px solid #e0e0e0;">

        <h3 style="margin-bottom: 16px;" id="userFormTitle">‚ûï Agregar Usuario</h3>
        <form id="inspectorForm">
          <input type="hidden" id="edit_user_id" value="">
          <div class="form-row-3">
            <div class="form-group">
              <label>Nombre Completo *</label>
              <input type="text" id="inspector_name" required placeholder="Carlos G√≥mez">
            </div>
            <div class="form-group">
              <label>Email *</label>
              <input type="email" id="inspector_email" required placeholder="carlos@dim.gob.ar">
            </div>
            <div class="form-group">
              <label>Contrase√±a <span id="passRequired">*</span></label>
              <input type="password" id="inspector_password" placeholder="********">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Rol</label>
              <select id="inspector_role">
                <option value="inspector">Inspector</option>
                <option value="admin">Administrador</option>
              </select>
            </div>
            <div class="form-group">
              <label>Zona Asignada</label>
              <select id="inspector_zone">
                <option value="">Sin zona espec√≠fica</option>
              </select>
            </div>
          </div>
          <div style="display:flex;gap:8px;">
            <button type="submit" class="btn btn-primary" id="userSubmitBtn">‚ûï Crear Usuario</button>
            <button type="button" class="btn" onclick="cancelEditUser()" id="userCancelBtn" style="display:none;background:#999;color:#fff;">Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Panel: Carga Manual -->
    <div id="create-panel" class="panel">
      <div class="card">
        <h2>‚ûï Cargar Inspecci√≥n Manual</h2>
        <form id="createForm">
          <div class="form-row">
            <div class="form-group">
              <label>üè™ Nombre del Comercio *</label>
              <input type="text" id="nombre_comercio" required placeholder="Comercio ABC">
            </div>
            <div class="form-group">
              <label>üî¢ Nro. Habilitaci√≥n</label>
              <input type="text" id="numero_habilitacion" placeholder="12345">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>üë§ Titular</label>
              <input type="text" id="titular" placeholder="Juan P√©rez">
            </div>
            <div class="form-group">
              <label>üî¢ CUIT</label>
              <input type="text" id="cuit" placeholder="20-12345678-9">
            </div>
          </div>

          <div class="form-group">
            <label>üìç Direcci√≥n *</label>
            <input type="text" id="direccion" required placeholder="Av. Sarmiento 1234, San Miguel de Tucum√°n">
          </div>

          <div class="form-row-3">
            <div class="form-group">
              <label>üì¶ Rubro</label>
              <input type="text" id="rubro" placeholder="ALIMENTOS">
            </div>
            <div class="form-group">
              <label>üìã Tipo Habilitaci√≥n</label>
              <input type="text" id="tipo_habilitacion" placeholder="COMERCIO">
            </div>
            <div class="form-group">
              <label>üè∑Ô∏è Zona</label>
              <input type="text" id="zona" placeholder="CENTRO">
            </div>
          </div>

          <button type="submit" class="btn btn-primary">‚úì Crear Inspecci√≥n</button>
        </form>
      </div>
    </div>
  </div>

  </div><!-- fin mainPanel -->

  <!-- Modal: Detalle -->
  <div id="detailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üìã Detalle de Inspecci√≥n</h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <div id="modal-body"></div>
    </div>
  </div>

  <!-- Modal: Editar Inspecci√≥n -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚úèÔ∏è Editar Inspecci√≥n</h2>
        <button class="close-btn" onclick="closeEditModal()">&times;</button>
      </div>
      <form id="editInspForm" onsubmit="saveEditInsp(event)">
        <input type="hidden" id="edit_insp_id">
        <div class="form-row">
          <div class="form-group"><label>Nombre Comercio *</label><input type="text" id="edit_nombre_comercio" required></div>
          <div class="form-group"><label>Nro. Habilitaci√≥n</label><input type="text" id="edit_numero_habilitacion"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Titular</label><input type="text" id="edit_titular"></div>
          <div class="form-group"><label>CUIT</label><input type="text" id="edit_cuit"></div>
        </div>
        <div class="form-group"><label>Direcci√≥n *</label><input type="text" id="edit_direccion" required></div>
        <div class="form-row-3">
          <div class="form-group"><label>Rubro</label><input type="text" id="edit_rubro"></div>
          <div class="form-group"><label>Tipo Habilitaci√≥n</label><input type="text" id="edit_tipo_habilitacion"></div>
          <div class="form-group"><label>Zona</label><input type="text" id="edit_zona"></div>
        </div>
        <div style="display:flex;gap:8px;margin-top:16px;">
          <button type="submit" class="btn btn-primary">üíæ Guardar Cambios</button>
          <button type="button" class="btn" style="background:#999;color:#fff;" onclick="closeEditModal()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ============= AUTENTICACI√ìN =============
    let authToken = localStorage.getItem('dim_token') || '';

    function doLogin() {
      const email = document.getElementById('loginEmail').value;
      const pass = document.getElementById('loginPassword').value;
      const errDiv = document.getElementById('loginError');
      errDiv.style.display = 'none';

      fetch('/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password: pass })
      })
      .then(r => r.json().then(d => ({ ok: r.ok, data: d })))
      .then(({ ok, data }) => {
        if (!ok || !data.token) {
          errDiv.textContent = data.error || 'Credenciales inv√°lidas';
          errDiv.style.display = 'block';
          return;
        }
        if (data.user.role !== 'admin') {
          errDiv.textContent = 'Acceso denegado: se requiere rol admin';
          errDiv.style.display = 'block';
          return;
        }
        authToken = data.token;
        localStorage.setItem('dim_token', authToken);
        localStorage.setItem('dim_user', JSON.stringify(data.user));
        showMainPanel(data.user);
      })
      .catch(() => {
        errDiv.textContent = 'Error de conexi√≥n';
        errDiv.style.display = 'block';
      });
    }

    function doLogout() {
      authToken = '';
      localStorage.removeItem('dim_token');
      localStorage.removeItem('dim_user');
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('mainPanel').style.display = 'none';
    }

    function showMainPanel(user) {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainPanel').style.display = 'block';
      document.getElementById('adminName').textContent = user.name || user.email;
      loadDashboard();
    }

    // Helper para fetch autenticado
    function authFetch(url, opts = {}) {
      opts.headers = { ...opts.headers, 'Authorization': `Bearer ${authToken}` };
      return fetch(url, opts).then(r => {
        if (r.status === 401) { doLogout(); throw new Error('Sesi√≥n expirada'); }
        return r;
      });
    }

    // Auto-login si hay token guardado
    (function checkSession() {
      if (authToken) {
        authFetch('/api/inspections/stats')
          .then(r => { if (r.ok) { showMainPanel(JSON.parse(localStorage.getItem('dim_user') || '{}')); } else doLogout(); })
          .catch(() => doLogout());
      }
    })();

    // ============= ESTADO GLOBAL =============
    let inspections = [];
    let inspectors = [];
    let currentPage = 1;
    let pageSize = 20;

    // Per-section pagination state
    const pagState = {
      importBatches: { page: 1, size: 20 },
      dashImports: { page: 1, size: 10 },
      assignPending: { page: 1, size: 20 },
      recorridos: { page: 1, size: 20 },
      recorridoDetail: { page: 1, size: 20 },
      inspectorsList: { page: 1, size: 20 },
    };

    function renderPaginatedTable(rows, headHtml, rowFn, tbodyOrContainer, pagCtrlId, stateKey, colCount) {
      const st = pagState[stateKey];
      const totalPages = Math.ceil(rows.length / st.size);
      if (st.page > totalPages && totalPages > 0) st.page = totalPages;
      const start = (st.page - 1) * st.size;
      const pageData = rows.slice(start, start + st.size);

      let html = '';
      if (typeof tbodyOrContainer === 'string') {
        // It's a container div ‚Äî render full table
        if (rows.length === 0) {
          document.getElementById(tbodyOrContainer).innerHTML = `<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>Sin datos</p></div>`;
          if (pagCtrlId) document.getElementById(pagCtrlId).innerHTML = '';
          return;
        }
        html = `<table>${headHtml}<tbody>${pageData.map(rowFn).join('')}</tbody></table>`;
        document.getElementById(tbodyOrContainer).innerHTML = html;
      } else {
        // It's a tbody element id
        if (rows.length === 0) {
          document.getElementById(tbodyOrContainer).innerHTML = `<tr><td colspan="${colCount||6}"><div class="empty-state"><p>Sin datos</p></div></td></tr>`;
          if (pagCtrlId) document.getElementById(pagCtrlId).innerHTML = '';
          return;
        }
        document.getElementById(tbodyOrContainer).innerHTML = pageData.map(rowFn).join('');
      }

      if (!pagCtrlId) return;
      const ctrl = document.getElementById(pagCtrlId);
      if (!ctrl) return;
      const pageSel = `<select onchange="pagState['${stateKey}'].size=parseInt(this.value);pagState['${stateKey}'].page=1;refreshSection('${stateKey}')" style="padding:4px 8px;border-radius:6px;border:1px solid #ddd;font-size:12px;">
        ${[10,20,50,100].map(s => `<option value="${s}" ${s===st.size?'selected':''}>${s} por p√°g</option>`).join('')}
      </select>`;
      {
        let p = `<span style="font-size:12px;color:#666;">${rows.length} resultados | P√°g ${st.page}/${totalPages || 1}</span>`;
        p += `<button class="btn btn-sm" style="background:#e0e0e0;color:#333;" onclick="pagState['${stateKey}'].page=1;refreshSection('${stateKey}')" ${st.page<=1?'disabled':''}>&laquo;</button>`;
        p += `<button class="btn btn-sm" style="background:#e0e0e0;color:#333;" onclick="pagState['${stateKey}'].page=${st.page-1};refreshSection('${stateKey}')" ${st.page<=1?'disabled':''}>&lsaquo;</button>`;
        if (totalPages > 0) {
          const sp = Math.max(1, st.page - 2), ep = Math.min(totalPages, st.page + 2);
          for (let i = sp; i <= ep; i++) {
            p += `<button class="btn btn-sm" style="background:${i===st.page?'#0066ff':'#e0e0e0'};color:${i===st.page?'#fff':'#333'};" onclick="pagState['${stateKey}'].page=${i};refreshSection('${stateKey}')">${i}</button>`;
          }
        }
        p += `<button class="btn btn-sm" style="background:#e0e0e0;color:#333;" onclick="pagState['${stateKey}'].page=${st.page+1};refreshSection('${stateKey}')" ${st.page>=totalPages?'disabled':''}>&rsaquo;</button>`;
        p += `<button class="btn btn-sm" style="background:#e0e0e0;color:#333;" onclick="pagState['${stateKey}'].page=${totalPages};refreshSection('${stateKey}')" ${st.page>=totalPages?'disabled':''}>&raquo;</button>`;
        p += pageSel;
        ctrl.innerHTML = p;
      }
    }

    // Cached data for re-pagination without refetch
    let _cache = {};

    function refreshSection(key) {
      if (key === 'importBatches') renderImportBatchesTable(_cache.importBatches || []);
      else if (key === 'dashImports') renderDashImportsTable(_cache.dashImports || []);
      else if (key === 'assignPending') renderAssignPendingTable(_cache.assignPending || []);
      else if (key === 'recorridos') renderRecorridosTable(_cache.recorridos || []);
      else if (key === 'recorridoDetail') renderRecorridoDetailTable(_cache.recorridoDetail || []);
      else if (key === 'inspectorsList') renderInspectorsTable(_cache.inspectorsList || []);
    }

    // ============= RENDER HELPERS FOR PAGINATED TABLES =============
    function renderImportBatchesTable(batches) {
      _cache.importBatches = batches;
      renderPaginatedTable(batches,
        '<thead><tr><th>ID</th><th>Archivo</th><th>Cronograma</th><th>Correo</th><th>Sucursal</th><th>Registros</th><th>Procesados</th><th>Fecha</th></tr></thead>',
        b => `<tr><td>#${b.id}</td><td>${b.filename}</td><td>${b.nro_cronograma}</td><td>${b.correo}</td><td>${b.sucursal}</td><td>${b.actual_records}</td><td>${b.processed}/${b.actual_records}</td><td>${formatDate(b.imported_at)}</td></tr>`,
        'import-batches-list', 'pag-importBatches', 'importBatches', 8
      );
    }

    function renderDashImportsTable(batches) {
      _cache.dashImports = batches;
      renderPaginatedTable(batches,
        '<thead><tr><th>ID</th><th>Archivo</th><th>Cronograma</th><th>Correo</th><th>Registros</th><th>Fecha</th></tr></thead>',
        b => `<tr><td>#${b.id}</td><td>${b.filename}</td><td>${b.nro_cronograma}</td><td>${b.correo}</td><td>${b.actual_records}/${b.total_records}</td><td>${formatDate(b.imported_at)}</td></tr>`,
        'import-history', 'pag-dashImports', 'dashImports', 6
      );
    }

    function renderAssignPendingTable(pending) {
      _cache.assignPending = pending;
      const st = pagState.assignPending;
      const totalPages = Math.ceil(pending.length / st.size);
      if (st.page > totalPages && totalPages > 0) st.page = totalPages;
      const start = (st.page - 1) * st.size;
      const pageData = pending.slice(start, start + st.size);
      const tbody = document.getElementById('pending-inspections-table');
      if (pending.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5"><div class="empty-state"><p>No hay inspecciones pendientes</p></div></td></tr>`;
        document.getElementById('pag-assignPending').innerHTML = '';
        return;
      }
      tbody.innerHTML = pageData.map(n => `<tr>
        <td class="checkbox-cell"><input type="checkbox" value="${n.id}" class="insp-checkbox"></td>
        <td>${n.numero_habilitacion || '-'}</td>
        <td>${n.nombre_comercio}</td>
        <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${n.direccion || '-'}</td>
        <td><span class="zone-badge">${n.zona || '-'}</span></td>
      </tr>`).join('');
      // Render pagination using the generic helper's pagination part
      const ctrl = document.getElementById('pag-assignPending');
      const pageSel = `<select onchange="pagState['assignPending'].size=parseInt(this.value);pagState['assignPending'].page=1;refreshSection('assignPending')" style="padding:4px 8px;border-radius:6px;border:1px solid #ddd;font-size:12px;">
        ${[10,20,50,100].map(s => `<option value="${s}" ${s===st.size?'selected':''}>${s} por p√°g</option>`).join('')}
      </select>`;
      {
        let p = `<span style="font-size:12px;color:#666;">${pending.length} pendientes | P√°g ${st.page}/${totalPages || 1}</span>`;
        p += `<button class="btn btn-sm" style="background:#e0e0e0;color:#333;" onclick="pagState['assignPending'].page=1;refreshSection('assignPending')" ${st.page<=1?'disabled':''}>&laquo;</button>`;
        p += `<button class="btn btn-sm" style="background:#e0e0e0;color:#333;" onclick="pagState['assignPending'].page=${st.page-1};refreshSection('assignPending')" ${st.page<=1?'disabled':''}>&lsaquo;</button>`;
        if (totalPages > 0) { const sp = Math.max(1, st.page-2), ep = Math.min(totalPages, st.page+2);
        for (let i = sp; i <= ep; i++) p += `<button class="btn btn-sm" style="background:${i===st.page?'#0066ff':'#e0e0e0'};color:${i===st.page?'#fff':'#333'};" onclick="pagState['assignPending'].page=${i};refreshSection('assignPending')">${i}</button>`; }
        p += `<button class="btn btn-sm" style="background:#e0e0e0;color:#333;" onclick="pagState['assignPending'].page=${st.page+1};refreshSection('assignPending')" ${st.page>=totalPages?'disabled':''}>&rsaquo;</button>`;
        p += `<button class="btn btn-sm" style="background:#e0e0e0;color:#333;" onclick="pagState['assignPending'].page=${totalPages};refreshSection('assignPending')" ${st.page>=totalPages?'disabled':''}>&raquo;</button>`;
        p += pageSel;
        ctrl.innerHTML = p;
      }
    }

    function renderRecorridosTable(data) {
      _cache.recorridos = data;
      renderPaginatedTable(data,
        '<thead><tr><th>Inspector</th><th>Email</th><th>Zona</th><th>Zonas asignadas</th><th>Pendientes</th><th>En curso</th><th>Completadas</th><th>Total</th><th></th></tr></thead>',
        r => `<tr>
          <td><strong>${r.name}</strong></td>
          <td>${r.email}</td>
          <td>${r.zone || '-'}</td>
          <td>${r.zonas ? r.zonas.split(',').map(z => '<span class="zone-badge">' + z + '</span>').join(' ') : '-'}</td>
          <td style="text-align:center;color:#e65100;">${r.pendientes || 0}</td>
          <td style="text-align:center;color:#1565c0;">${r.en_curso || 0}</td>
          <td style="text-align:center;color:#0066ff;">${r.completadas || 0}</td>
          <td style="text-align:center;"><strong>${r.total || 0}</strong></td>
          <td>${r.total > 0 ? `<button class="action-btn btn-view" onclick="viewRecorrido(${r.inspector_id}, '${r.name}')">Ver detalle</button>` : ''}</td>
        </tr>`,
        'recorridos-list', 'pag-recorridos', 'recorridos', 9
      );
    }

    function renderRecorridoDetailTable(data) {
      _cache.recorridoDetail = data;
      const st = pagState.recorridoDetail;
      const totalPages = Math.ceil(data.length / st.size);
      if (st.page > totalPages && totalPages > 0) st.page = totalPages;
      const start = (st.page - 1) * st.size;
      const pageData = data.slice(start, start + st.size);
      const tbody = document.querySelector('#recorrido-detail-table tbody');
      tbody.innerHTML = pageData.map(n => `
        <tr>
          <td class="checkbox-cell"><input type="checkbox" value="${n.id}"></td>
          <td>${n.numero_habilitacion || '-'}</td>
          <td>${n.nombre_comercio}</td>
          <td>${n.direccion || '-'}</td>
          <td>${n.zona ? '<span class="zone-badge">' + n.zona + '</span>' : '-'}</td>
          <td><span class="status-badge status-${n.status}">${n.status === 'pending' ? 'PENDIENTE' : n.status === 'in_progress' ? 'EN CURSO' : 'COMPLETADA'}</span></td>
        </tr>
      `).join('');
      const ctrl = document.getElementById('pag-recorridoDetail');
      const pageSel = `<select onchange="pagState['recorridoDetail'].size=parseInt(this.value);pagState['recorridoDetail'].page=1;refreshSection('recorridoDetail')" style="padding:4px 8px;border-radius:6px;border:1px solid #ddd;font-size:12px;">
        ${[10,20,50,100].map(s => `<option value="${s}" ${s===st.size?'selected':''}>${s} por p√°g</option>`).join('')}
      </select>`;
      {
        let p = `<span style="font-size:12px;color:#666;">${data.length} inspecciones | P√°g ${st.page}/${totalPages || 1}</span>`;
        p += `<button class="btn btn-sm" style="background:#e0e0e0;color:#333;" onclick="pagState['recorridoDetail'].page=1;refreshSection('recorridoDetail')" ${st.page<=1?'disabled':''}>&laquo;</button>`;
        p += `<button class="btn btn-sm" style="background:#e0e0e0;color:#333;" onclick="pagState['recorridoDetail'].page=${st.page-1};refreshSection('recorridoDetail')" ${st.page<=1?'disabled':''}>&lsaquo;</button>`;
        if (totalPages > 0) { const sp = Math.max(1, st.page-2), ep = Math.min(totalPages, st.page+2);
        for (let i = sp; i <= ep; i++) p += `<button class="btn btn-sm" style="background:${i===st.page?'#0066ff':'#e0e0e0'};color:${i===st.page?'#fff':'#333'};" onclick="pagState['recorridoDetail'].page=${i};refreshSection('recorridoDetail')">${i}</button>`; }
        p += `<button class="btn btn-sm" style="background:#e0e0e0;color:#333;" onclick="pagState['recorridoDetail'].page=${st.page+1};refreshSection('recorridoDetail')" ${st.page>=totalPages?'disabled':''}>&rsaquo;</button>`;
        p += `<button class="btn btn-sm" style="background:#e0e0e0;color:#333;" onclick="pagState['recorridoDetail'].page=${totalPages};refreshSection('recorridoDetail')" ${st.page>=totalPages?'disabled':''}>&raquo;</button>`;
        p += pageSel;
        ctrl.innerHTML = p;
      }
    }

    function renderInspectorsTable(list) {
      _cache.inspectorsList = list;
      renderPaginatedTable(list,
        '<thead><tr><th>Nombre</th><th>Email</th><th>Rol</th><th>Zona</th><th>Pend.</th><th>Compl.</th><th>Acciones</th></tr></thead>',
        n => `<tr>
          <td><strong>${n.name}</strong></td>
          <td>${n.email}</td>
          <td><span class="status-badge status-${n.role === 'admin' ? 'completed' : 'pending'}">${n.role === 'admin' ? 'ADMIN' : 'INSPECTOR'}</span></td>
          <td>${n.zone ? '<span class="zone-badge">' + n.zone + '</span>' : '-'}</td>
          <td style="text-align:center;color:#e65100;">${n.pending_count}</td>
          <td style="text-align:center;color:#0066ff;">${n.completed_count}</td>
          <td>
            <button class="action-btn btn-view" onclick="editUser(${n.id})" title="Editar">‚úèÔ∏è</button>
            <button class="action-btn btn-delete" onclick="deleteInspector(${n.id})" title="Eliminar">üóëÔ∏è</button>
          </td>
        </tr>`,
        'inspectors-list', 'pag-inspectorsList', 'inspectorsList', 7
      );
    }

    // ============= NAVEGACI√ìN =============
    function switchTab(tab, el) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      if (el) {
        el.classList.add('active');
      } else {
        // Find the tab button by matching onclick
        document.querySelectorAll('.tab').forEach(t => {
          if (t.getAttribute('onclick') && t.getAttribute('onclick').includes("'" + tab + "'")) {
            t.classList.add('active');
          }
        });
      }
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.getElementById(`${tab}-panel`).classList.add('active');

      if (tab === 'dashboard') loadDashboard();
      if (tab === 'import') loadImportBatches();
      if (tab === 'list') loadInspections();
      if (tab === 'assign') loadAssignmentPanel();
      if (tab === 'recorridos') loadRecorridos();
      if (tab === 'inspectors') loadInspectors();
    }

    // ============= ALERTAS =============
    function showAlert(message, type = 'success') {
      const el = type === 'success' ? document.getElementById('alertSuccess') : document.getElementById('alertError');
      el.textContent = message;
      el.classList.add('active');
      setTimeout(() => el.classList.remove('active'), 5000);
    }

    // ============= DASHBOARD =============
    async function loadDashboard() {
      try {
        const [statsRes, recentRes, batchesRes] = await Promise.all([
          authFetch('/api/inspections/stats'),
          authFetch('/api/inspections?limit=5'),
          authFetch('/api/import/batches')
        ]);

        const stats = await statsRes.json();
        const recent = await recentRes.json();
        const batches = await batchesRes.json();

        document.getElementById('stat-total').textContent = stats.total || 0;
        document.getElementById('stat-pending').textContent = stats.pending || 0;
        document.getElementById('stat-completed').textContent = stats.completed || 0;
        document.getElementById('stat-imports').textContent = batches.length || 0;

        const container = document.getElementById('recent-inspections');
        if (recent.length === 0) {
          container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No hay inspecciones. Import√° un listado PDF para empezar.</p></div>`;
        } else {
          container.innerHTML = `<table><thead><tr><th>ID</th><th>Nro Orden</th><th>Cliente</th><th>Zona</th><th>Estado</th></tr></thead><tbody>
            ${recent.map(n => `<tr><td>#${n.id}</td><td>${n.numero_habilitacion || '-'}</td><td>${n.nombre_comercio}</td><td><span class="zone-badge">${n.zona || '-'}</span></td><td><span class="status-badge status-${n.status}">${getStatusText(n.status)}</span></td></tr>`).join('')}
          </tbody></table>`;
        }

        renderDashImportsTable(batches);
      } catch (error) {
        console.error('Error cargando dashboard:', error);
      }
    }

    // ============= IMPORTAR PDF =============
    const uploadArea = document.getElementById('uploadArea');
    uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0 && files[0].type === 'application/pdf') {
        document.getElementById('csvFile').files = files;
        uploadCSV();
      } else {
        showAlert('Solo se aceptan archivos PDF', 'error');
      }
    });

    async function uploadCSV() {
      const fileInput = document.getElementById('csvFile');
      if (!fileInput.files[0]) return;

      document.getElementById('uploadProgress').style.display = 'block';
      document.getElementById('importResult').style.display = 'none';

      const formData = new FormData();
      formData.append('file', fileInput.files[0]);

      try {
        const response = await authFetch('/api/import/csv', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        document.getElementById('uploadProgress').style.display = 'none';

        if (!response.ok) throw new Error(result.error);

        const resultDiv = document.getElementById('importResult');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
          <div class="import-result">
            <h3 style="margin-bottom: 12px; color: #155724;">‚úÖ Importaci√≥n Exitosa</h3>
            <div style="margin-bottom: 16px;">
              <span class="import-stat" style="background: #e6f0ff; color: #0066ff;">üì¶ Batch #${result.batch_id}</span>
              <span class="import-stat" style="background: #d4edda; color: #155724;">‚úÖ Insertados: ${result.inserted}</span>
              <span class="import-stat" style="background: #fff3cd; color: #856404;">‚ö†Ô∏è Duplicados: ${result.duplicates}</span>
              <span class="import-stat" style="background: #d1ecf1; color: #0c5460;">üìä Total parseados: ${result.total_parsed}</span>
            </div>
            <div style="margin-bottom: 12px;">
              <strong>Cronograma:</strong> ${result.metadata.nro_cronograma} |
              <strong>Correo:</strong> ${result.metadata.correo} |
              <strong>Sucursal:</strong> ${result.metadata.sucursal}
            </div>
            ${result.records_preview.length > 0 ? `
              <h4 style="margin-bottom: 8px;">Vista previa (primeros ${result.records_preview.length}):</h4>
              <table>
                <thead><tr><th>Nro Orden</th><th>Sum.</th><th>Cliente</th><th>Domicilio</th><th>Zona</th></tr></thead>
                <tbody>
                  ${result.records_preview.map(r => `<tr><td>${r.numero_habilitacion}</td><td>${r.titular}</td><td>${r.nombre_comercio}</td><td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${r.direccion}</td><td><span class="zone-badge">${r.zona || '-'}</span></td></tr>`).join('')}
                </tbody>
              </table>
            ` : ''}
          </div>
        `;

        showAlert(`‚úÖ ${result.inserted} inspecciones importadas del cronograma ${result.metadata.nro_cronograma}`, 'success');
        fileInput.value = '';
        loadImportBatches();
      } catch (error) {
        document.getElementById('uploadProgress').style.display = 'none';
        showAlert(`‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function loadImportBatches() {
      try {
        const response = await authFetch('/api/import/batches');
        const batches = await response.json();

        renderImportBatchesTable(batches);
      } catch (error) {
        console.error('Error cargando batches:', error);
      }
    }

    // ============= INSPECCIONES =============
    function goToListWithFilter(status) {
      currentPage = 1;
      switchTab('list');
      document.getElementById('filterStatus').value = status;
      loadInspections();
    }

    function changePage(page) {
      currentPage = page;
      loadInspections();
    }

    function changePageSize(size) {
      pageSize = parseInt(size);
      currentPage = 1;
      loadInspections();
    }

    async function loadInspections() {
      try {
        const response = await authFetch('/api/inspections');
        inspections = await response.json();

        // Cargar zonas para filtro
        const zonesRes = await authFetch('/api/inspections/zones');
        const zones = await zonesRes.json();
        const filterZone = document.getElementById('filterZone');
        const currentVal = filterZone.value;
        filterZone.innerHTML = '<option value="">Todas las zonas</option>' +
          zones.map(z => `<option value="${z.zona}" ${z.zona === currentVal ? 'selected' : ''}>${z.zona} (${z.count})</option>`).join('');

        // Aplicar filtros
        const statusFilter = document.getElementById('filterStatus').value;
        const zoneFilter = document.getElementById('filterZone').value;
        const searchFilter = (document.getElementById('filterSearch').value || '').toLowerCase().trim();
        const sortFilter = document.getElementById('filterSort').value;

        let filtered = inspections;
        if (statusFilter === 'completed') {
          filtered = filtered.filter(n => n.status === 'synced' || n.status === 'completed');
        } else if (statusFilter) {
          filtered = filtered.filter(n => n.status === statusFilter);
        }
        if (zoneFilter) filtered = filtered.filter(n => n.zona && n.zona.includes(zoneFilter));
        if (searchFilter) {
          filtered = filtered.filter(n =>
            (n.nombre_comercio && n.nombre_comercio.toLowerCase().includes(searchFilter)) ||
            (n.direccion && n.direccion.toLowerCase().includes(searchFilter)) ||
            (n.numero_habilitacion && n.numero_habilitacion.toString().includes(searchFilter)) ||
            (n.titular && n.titular.toString().includes(searchFilter))
          );
        }

        // Ordenar
        if (sortFilter === 'oldest') {
          filtered.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
        } else if (sortFilter === 'newest') {
          filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        } else if (sortFilter === 'name_asc') {
          filtered.sort((a, b) => (a.citizen_name || '').localeCompare(b.citizen_name || ''));
        } else if (sortFilter === 'name_desc') {
          filtered.sort((a, b) => (b.citizen_name || '').localeCompare(a.citizen_name || ''));
        }

        const tbody = document.getElementById('inspections-table');
        const pagCtrl = document.getElementById('pagination-controls');
        if (filtered.length === 0) {
          tbody.innerHTML = `<tr><td colspan="10"><div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No hay inspecciones</p></div></td></tr>`;
          pagCtrl.innerHTML = '';
        } else {
          const totalPages = Math.ceil(filtered.length / pageSize);
          if (currentPage > totalPages) currentPage = totalPages;
          const start = (currentPage - 1) * pageSize;
          const pageData = filtered.slice(start, start + pageSize);

          tbody.innerHTML = pageData.map(n => `<tr>
            <td><strong>#${n.id}</strong></td>
            <td>${n.numero_habilitacion || '-'}</td>
            <td>${n.nombre_comercio}</td>
            <td>${n.titular || '-'}</td>
            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${(n.direccion || '').replace(/"/g, '&quot;')}">${n.direccion || '-'}</td>
            <td><span class="zone-badge">${n.zona || '-'}</span></td>
            <td><span class="status-badge status-${n.status}">${getStatusText(n.status)}</span></td>
            <td style="font-size:12px;">${n.created_at ? formatDate(n.created_at) : '-'}</td>
            <td>${n.inspector_name || (n.inspector_id ? '#' + n.inspector_id : '-')}</td>
            <td>
              <button class="action-btn btn-view" onclick="viewDetail(${n.id})">üëÅÔ∏è</button>
              <button class="action-btn btn-assign" onclick="editInspection(${n.id})">‚úèÔ∏è</button>
              <button class="action-btn btn-delete" onclick="deleteInspection(${n.id})">üóëÔ∏è</button>
            </td>
          </tr>`).join('');

          // Pagination controls
          const pageSel = `<select onchange="changePageSize(this.value)" style="padding:4px 8px;border-radius:6px;border:1px solid #ddd;font-size:12px;">
            ${[10,20,50,100].map(s => `<option value="${s}" ${s===pageSize?'selected':''}>${s} por p√°g</option>`).join('')}
          </select>`;
          {
            let phtml = `<span style="font-size:12px;color:#666;">${filtered.length} resultados | P√°g ${currentPage}/${totalPages || 1}</span>`;
            phtml += `<button class="btn btn-sm" style="background:#e0e0e0;color:#333;" onclick="changePage(1)" ${currentPage<=1?'disabled':''}>&laquo;</button>`;
            phtml += `<button class="btn btn-sm" style="background:#e0e0e0;color:#333;" onclick="changePage(${currentPage-1})" ${currentPage<=1?'disabled':''}>&lsaquo;</button>`;
            if (totalPages > 0) {
              const startP = Math.max(1, currentPage - 2);
              const endP = Math.min(totalPages, currentPage + 2);
              for (let i = startP; i <= endP; i++) {
                phtml += `<button class="btn btn-sm" style="background:${i===currentPage?'#0066ff':'#e0e0e0'};color:${i===currentPage?'#fff':'#333'};" onclick="changePage(${i})">${i}</button>`;
              }
            }
            phtml += `<button class="btn btn-sm" style="background:#e0e0e0;color:#333;" onclick="changePage(${currentPage+1})" ${currentPage>=totalPages?'disabled':''}>&rsaquo;</button>`;
            phtml += `<button class="btn btn-sm" style="background:#e0e0e0;color:#333;" onclick="changePage(${totalPages})" ${currentPage>=totalPages?'disabled':''}>&raquo;</button>`;
            phtml += pageSel;
            pagCtrl.innerHTML = phtml;
          }
        }
      } catch (error) {
        showAlert(`‚ùå Error: ${error.message}`, 'error');
      }
    }

    // ============= ASIGNACI√ìN DE RECORRIDOS =============
    async function loadAssignmentPanel() {
      try {
        const [zonesRes, inspectorsRes, pendingRes] = await Promise.all([
          authFetch('/api/inspections/zones'),
          authFetch('/api/inspectors'),
          authFetch('/api/inspections')
        ]);

        const zones = await zonesRes.json();
        inspectors = await inspectorsRes.json();
        const allInspections = await pendingRes.json();
        const pending = allInspections.filter(n => n.status === 'pending');

        // Zona assignment list
        const zoneContainer = document.getElementById('zone-assignment-list');
        if (zones.length === 0) {
          zoneContainer.innerHTML = `<div class="empty-state"><p>No hay zonas con inspecciones pendientes. Import√° un listado primero.</p></div>`;
        } else {
          zoneContainer.innerHTML = zones.map(z => `
            <div class="inspector-card">
              <div class="inspector-info">
                <h3>üìç ${z.zona}</h3>
                <p>${z.count} inspecciones pendientes</p>
              </div>
              <div style="display: flex; gap: 8px; align-items: center;">
                <select id="zone-inspector-${z.zona.replace(/[^a-zA-Z0-9]/g, '_')}" style="padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                  <option value="">Seleccionar inspector...</option>
                  ${inspectors.map(n => `<option value="${n.id}">${n.name} ${n.zone ? '(' + n.zone + ')' : ''}</option>`).join('')}
                </select>
                <button class="btn btn-warning btn-sm" onclick="assignZone('${z.zona}')">üìå Asignar</button>
              </div>
            </div>
          `).join('');
        }

        // Inspectors select for individual assignment
        const assignSelect = document.getElementById('assignInspector');
        assignSelect.innerHTML = '<option value="">Seleccionar inspector...</option>' +
          inspectors.map(n => `<option value="${n.id}">${n.name} ${n.zone ? '(' + n.zone + ')' : ''}</option>`).join('');

        // Pending inspections table
        renderAssignPendingTable(pending);
      } catch (error) {
        console.error('Error cargando panel de asignaci√≥n:', error);
      }
    }

    async function assignZone(zone) {
      const selectId = `zone-inspector-${zone.replace(/[^a-zA-Z0-9]/g, '_')}`;
      const inspectorId = document.getElementById(selectId).value;

      if (!inspectorId) {
        showAlert('Seleccion√° un inspector primero', 'error');
        return;
      }

      try {
        const response = await authFetch('/api/assign', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ inspector_id: parseInt(inspectorId), zone: zone })
        });

        const result = await response.json();
        if (!response.ok) throw new Error(result.error);

        showAlert(`‚úÖ ${result.assigned} inspecciones asignadas de zona "${zone}"`, 'success');
        loadAssignmentPanel();
      } catch (error) {
        showAlert(`‚ùå Error: ${error.message}`, 'error');
      }
    }

    function toggleSelectAll() {
      const checked = document.getElementById('selectAll').checked;
      document.querySelectorAll('.insp-checkbox').forEach(cb => cb.checked = checked);
    }

    async function assignSelected() {
      const inspectorId = document.getElementById('assignInspector').value;
      if (!inspectorId) {
        showAlert('Seleccion√° un inspector primero', 'error');
        return;
      }

      const selectedIds = Array.from(document.querySelectorAll('.insp-checkbox:checked')).map(cb => parseInt(cb.value));
      if (selectedIds.length === 0) {
        showAlert('Seleccion√° al menos una inspecci√≥n', 'error');
        return;
      }

      try {
        const response = await authFetch('/api/assign', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ inspector_id: parseInt(inspectorId), inspection_ids: selectedIds })
        });

        const result = await response.json();
        if (!response.ok) throw new Error(result.error);

        showAlert(`‚úÖ ${result.assigned} inspecciones asignadas`, 'success');
        loadAssignmentPanel();
      } catch (error) {
        showAlert(`‚ùå Error: ${error.message}`, 'error');
      }
    }

    // ============= INSPECTORES =============
    // ============= GESTI√ìN DE USUARIOS =============
    async function loadInspectors() {
      try {
        const [inspectorsRes, zonesRes] = await Promise.all([
          authFetch('/api/inspectors'),
          authFetch('/api/zones')
        ]);

        inspectors = await inspectorsRes.json();
        const zones = await zonesRes.json();

        renderInspectorsTable(inspectors);

        // Cargar zonas en el select
        const zoneSelect = document.getElementById('inspector_zone');
        zoneSelect.innerHTML = '<option value="">Sin zona espec√≠fica</option>' +
          zones.map(z => `<option value="${z.name}">${z.name}</option>`).join('');
      } catch (error) {
        console.error('Error cargando usuarios:', error);
      }
    }

    function editUser(id) {
      const user = inspectors.find(n => n.id === id);
      if (!user) return;
      document.getElementById('edit_user_id').value = id;
      document.getElementById('inspector_name').value = user.name;
      document.getElementById('inspector_email').value = user.email;
      document.getElementById('inspector_password').value = '';
      document.getElementById('inspector_role').value = user.role;
      document.getElementById('inspector_zone').value = user.zone || '';
      document.getElementById('userFormTitle').textContent = '‚úèÔ∏è Editar Usuario: ' + user.name;
      document.getElementById('userSubmitBtn').textContent = 'üíæ Guardar Cambios';
      document.getElementById('userCancelBtn').style.display = 'inline-block';
      document.getElementById('passRequired').textContent = '(dejar vac√≠o para mantener)';
      document.getElementById('inspector_password').removeAttribute('required');
    }

    function cancelEditUser() {
      document.getElementById('edit_user_id').value = '';
      document.getElementById('inspectorForm').reset();
      document.getElementById('userFormTitle').textContent = '‚ûï Agregar Usuario';
      document.getElementById('userSubmitBtn').textContent = '‚ûï Crear Usuario';
      document.getElementById('userCancelBtn').style.display = 'none';
      document.getElementById('passRequired').textContent = '*';
    }

    document.getElementById('inspectorForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const editId = document.getElementById('edit_user_id').value;
      const body = {
        name: document.getElementById('inspector_name').value,
        email: document.getElementById('inspector_email').value,
        role: document.getElementById('inspector_role').value,
        zone: document.getElementById('inspector_zone').value
      };
      const pass = document.getElementById('inspector_password').value;
      if (pass) body.password = pass;

      try {
        let response;
        if (editId) {
          response = await authFetch(`/api/inspectors/${editId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
        } else {
          if (!pass) { showAlert('La contrase√±a es obligatoria para usuarios nuevos', 'error'); return; }
          body.password = pass;
          response = await authFetch('/api/inspectors', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
        }

        const result = await response.json();
        if (!response.ok) throw new Error(result.error);

        showAlert(editId ? 'Usuario actualizado' : 'Usuario creado', 'success');
        cancelEditUser();
        loadInspectors();
      } catch (error) {
        showAlert(`Error: ${error.message}`, 'error');
      }
    });

    async function deleteInspector(id) {
      if (!confirm('¬øEliminar este usuario? Sus inspecciones ser√°n desasignadas.')) return;
      try {
        const response = await authFetch(`/api/inspectors/${id}`, { method: 'DELETE' });
        const result = await response.json();
        if (!response.ok) throw new Error(result.error);
        showAlert('Usuario eliminado', 'success');
        loadInspectors();
      } catch (error) {
        showAlert(`Error: ${error.message}`, 'error');
      }
    }

    // ============= RECORRIDOS =============
    let currentRecorridoInspector = null;

    async function loadRecorridos() {
      try {
        const res = await authFetch('/api/recorridos');
        const data = await res.json();
        renderRecorridosTable(data);
        document.getElementById('recorrido-detail').style.display = 'none';
      } catch (error) {
        console.error('Error cargando recorridos:', error);
      }
    }

    async function viewRecorrido(inspectorId, name) {
      currentRecorridoInspector = inspectorId;
      try {
        const res = await authFetch(`/api/recorridos/${inspectorId}`);
        const data = await res.json();
        document.getElementById('recorrido-detail-title').textContent = 'üìç Recorrido de ' + name + ` (${data.length} inspecciones)`;
        pagState.recorridoDetail.page = 1;
        renderRecorridoDetailTable(data);
        document.getElementById('recorrido-detail').style.display = 'block';
      } catch (error) {
        showAlert('Error cargando detalle', 'error');
      }
    }

    function toggleAllRecorrido(master) {
      document.querySelectorAll('#recorrido-detail-table tbody input[type=checkbox]').forEach(cb => cb.checked = master.checked);
    }

    async function unassignSelected() {
      const ids = [...document.querySelectorAll('#recorrido-detail-table tbody input[type=checkbox]:checked')].map(cb => parseInt(cb.value));
      if (ids.length === 0) { showAlert('Selecciona inspecciones para desasignar', 'error'); return; }
      if (!confirm(`¬øDesasignar ${ids.length} inspecciones?`)) return;
      try {
        const res = await authFetch('/api/unassign', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ inspection_ids: ids })
        });
        const result = await res.json();
        if (!res.ok) throw new Error(result.error);
        showAlert(`${result.unassigned} inspecciones desasignadas`, 'success');
        viewRecorrido(currentRecorridoInspector, document.getElementById('recorrido-detail-title').textContent.split(' de ')[1]);
        loadRecorridos();
      } catch (error) {
        showAlert(`Error: ${error.message}`, 'error');
      }
    }

    async function unassignAll() {
      if (!confirm('¬øDesasignar TODAS las inspecciones de este inspector?')) return;
      try {
        const res = await authFetch('/api/unassign', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ inspector_id: currentRecorridoInspector })
        });
        const result = await res.json();
        if (!res.ok) throw new Error(result.error);
        showAlert(`${result.unassigned} inspecciones desasignadas`, 'success');
        document.getElementById('recorrido-detail').style.display = 'none';
        loadRecorridos();
      } catch (error) {
        showAlert(`Error: ${error.message}`, 'error');
      }
    }

    // ============= CREAR INSPECCI√ìN MANUAL =============
    document.getElementById('createForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const response = await authFetch('/api/inspections', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            citizen_name: document.getElementById('citizen_name').value,
            citizen_phone: document.getElementById('citizen_phone').value,
            address: document.getElementById('address').value,
            latitude: parseFloat(document.getElementById('latitude').value) || null,
            longitude: parseFloat(document.getElementById('longitude').value) || null
          })
        });

        const result = await response.json();
        if (!response.ok) throw new Error(result.error);

        showAlert(`‚úÖ Inspecci√≥n creada (ID: ${result.id})`, 'success');
        document.getElementById('createForm').reset();
      } catch (error) {
        showAlert(`‚ùå Error: ${error.message}`, 'error');
      }
    });

    // ============= DETALLE =============
    async function viewDetail(id) {
      try {
        const response = await authFetch(`/api/inspections/${id}`);
        const n = await response.json();

        document.getElementById('modal-body').innerHTML = `
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">ID</div>
              <div class="detail-value">#${n.id}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Estado</div>
              <div class="detail-value"><span class="status-badge status-${n.status}">${getStatusText(n.status)}</span></div>
            </div>
            <div class="detail-item" style="grid-column: 1 / -1;">
              <div class="detail-label">Nombre Comercio</div>
              <div class="detail-value" style="font-size:16px; font-weight:600;">${n.nombre_comercio || '-'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Nro. Habilitaci√≥n</div>
              <div class="detail-value">${n.numero_habilitacion || '-'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Tipo Habilitaci√≥n</div>
              <div class="detail-value">${n.tipo_habilitacion || '-'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Titular</div>
              <div class="detail-value">${n.titular || '-'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">CUIT</div>
              <div class="detail-value">${n.cuit || '-'}</div>
            </div>
            <div class="detail-item" style="grid-column: 1 / -1;">
              <div class="detail-label">Direcci√≥n</div>
              <div class="detail-value">${n.direccion || '-'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Rubro</div>
              <div class="detail-value">${n.rubro || '-'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Zona</div>
              <div class="detail-value"><span class="zone-badge">${n.zona || '-'}</span></div>
            </div>
            ${n.detalle ? `
              <div class="detail-item" style="grid-column: 1 / -1;">
                <div class="detail-label">Detalle/Observaciones</div>
                <div class="detail-value" style="background:#f8f9fa; padding:8px; border-radius:4px;">${n.detalle}</div>
              </div>
            ` : ''}
            ${n.latitude && n.longitude ? `
              <div class="detail-item"><div class="detail-label">Latitud</div><div class="detail-value">${n.latitude}</div></div>
              <div class="detail-item"><div class="detail-label">Longitud</div><div class="detail-value">${n.longitude}</div></div>
            ` : ''}
            ${n.photo_path ? `<div class="detail-item" style="grid-column: 1 / -1;"><div class="detail-label">Foto</div><img src="${n.photo_path}" class="image-preview" alt="Foto"></div>` : ''}
            ${n.signature_path ? `<div class="detail-item" style="grid-column: 1 / -1;"><div class="detail-label">Firma</div><div style="background:#fff; border:1px solid #ddd; border-radius:4px; padding:8px; text-align:center;"><img src="${n.signature_path}" style="max-width:100%; height:auto; max-height:200px;" alt="Firma"></div></div>` : ''}
            <div class="detail-item"><div class="detail-label">Fecha Alta</div><div class="detail-value">${formatDate(n.created_at)}</div></div>
            <div class="detail-item"><div class="detail-label">Fecha Inspecci√≥n</div><div class="detail-value">${n.inspected_at ? formatDate(n.inspected_at) : '-'}</div></div>
            ${n.token ? `<div class="detail-item" style="grid-column: 1 / -1;"><div class="detail-label">Token</div><div class="detail-value" style="font-family: monospace; font-size: 11px;">${n.token}</div></div>` : ''}
          </div>
          <div style="margin-top:16px; text-align:right;">
            ${n.token ? `<a href="/verificar/${n.token}" target="_blank" class="btn btn-success btn-sm" style="text-decoration:none;">üìÑ Ver Constancia</a>` : ''}
          </div>
        `;

        document.getElementById('detailModal').classList.add('active');
      } catch (error) {
        showAlert(`‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function editInspection(id) {
      try {
        const response = await authFetch(`/api/inspections/${id}`);
        const n = await response.json();
        document.getElementById('edit_insp_id').value = n.id;
        document.getElementById('edit_nombre_comercio').value = n.nombre_comercio || '';
        document.getElementById('edit_numero_habilitacion').value = n.numero_habilitacion || '';
        document.getElementById('edit_titular').value = n.titular || '';
        document.getElementById('edit_cuit').value = n.cuit || '';
        document.getElementById('edit_direccion').value = n.direccion || '';
        document.getElementById('edit_rubro').value = n.rubro || '';
        document.getElementById('edit_tipo_habilitacion').value = n.tipo_habilitacion || '';
        document.getElementById('edit_zona').value = n.zona || '';
        document.getElementById('editModal').classList.add('active');
      } catch (error) {
        showAlert('Error cargando inspecci√≥n', 'error');
      }
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
    }

    async function saveEditInsp(e) {
      e.preventDefault();
      const id = document.getElementById('edit_insp_id').value;
      const body = {
        nombre_comercio: document.getElementById('edit_nombre_comercio').value,
        numero_habilitacion: document.getElementById('edit_numero_habilitacion').value,
        titular: document.getElementById('edit_titular').value,
        cuit: document.getElementById('edit_cuit').value,
        direccion: document.getElementById('edit_direccion').value,
        rubro: document.getElementById('edit_rubro').value,
        tipo_habilitacion: document.getElementById('edit_tipo_habilitacion').value,
        zona: document.getElementById('edit_zona').value,
      };
      try {
        const response = await authFetch(`/api/inspections/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const result = await response.json();
        if (!response.ok) throw new Error(result.error);
        showAlert('Inspecci√≥n actualizada', 'success');
        closeEditModal();
        loadInspections();
      } catch (error) {
        showAlert(`Error: ${error.message}`, 'error');
      }
    }

    async function deleteInspection(id) {
      if (!confirm('¬øEliminar esta inspecci√≥n?')) return;
      try {
        await authFetch(`/api/inspections/${id}`, { method: 'DELETE' });
        showAlert('‚úÖ Eliminada', 'success');
        loadInspections();
        loadDashboard();
      } catch (error) {
        showAlert(`‚ùå Error: ${error.message}`, 'error');
      }
    }

    function closeModal() {
      document.getElementById('detailModal').classList.remove('active');
    }

    // ============= UTILIDADES =============
    function getStatusText(status) {
      return { 'pending': 'Pendiente', 'in_progress': 'En Progreso', 'synced': 'Completada', 'completed': 'Completada' }[status] || status;
    }

    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      return new Date(dateString).toLocaleString('es-AR');
    }

    // ============= INIT =============
    window.addEventListener('load', loadDashboard);

    document.getElementById('detailModal').addEventListener('click', (e) => {
      if (e.target.id === 'detailModal') closeModal();
    });
    document.getElementById('editModal').addEventListener('click', (e) => {
      if (e.target.id === 'editModal') closeEditModal();
    });
  </script>
</body>
</html>